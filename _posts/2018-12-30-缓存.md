---
layout:  post
title:		缓存
subtitle:		缓存
date:     2018-12-30
author:   Fogeeks
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - Redis 
    - 缓存
---
  
- *适用场景*
    - 热点数据缓存以提高响应速度，如hset，用户信息，工单状态信息，产品类型信息，来源信息，地址信息
    - 消息队列,如lpush rpop ,sub/pub
    - 排行榜 如zadd zrange zrank
    - 计数器 如incr
    - 共同关注 如 sadd spop sunion
    - 分布式锁 如 set lock true ex 1 xx

- *缓存方案*
    - replication sentinal 哨兵 ， 支持故障转移，水平扩容时的数据迁移是瓶颈，所以只适合轻量级缓存
    - redis cluster 集群， 支持故障转移和水平扩容，数据分发到16384个hashslot，适合大型缓存系统

- *持久化*
    - rdb : `` save 600 10 `` 10分钟内有10个键被改动就会触发rdb备份 ，保存键值数据，备份时间较长，有数据丢失的风险， 恢复速度快，备份文件较小
    - aof : `` appendfsync everysec `` 每秒备份一次 ，写命令追加到缓冲区末，随后写入aof文件并同步，数据更安全，恢复速度较慢，备份文件较大

- *一致性问题解决方*
    - 异步串行化

- *主从复制*
    - 周期性发送同步命令，异步复制并发送rdb数据
    - 清除旧数据刷新新数据到内存，这段时间服务不可用

- *搭建细节*
    - redis安装目录 ： ``mkdir -p /usr/local/redis-cluster/redis-5.0.3``
    - redis启动脚本：
        ```$xslt
           cd ../node-1 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-2 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-3 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-4 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-5 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-6 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           ps -ef | grep redis-server
           sudo redis-5.0.3/src/redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006  --cluster-replicas 1
        ```        
    - 连接redis： ``redis-5.0.3/src/redis-cli -c -p 7001``
    - 增删redis集群节点
        ```$xslt
            redis-5.0.3/src/redis-cli --cluster add-node 127.0.0.1:7002  127.0.0.1:7001
            redis-5.0.3/src/redis-cli --cluster del-node 127.0.0.1:7002 bd64b831c5fb0a19fe357fc7eef00cfe41c2734d
        ```
    - 干翻所有redis: ``ps -ef |grep redis-server  | awk '/cluster/{print$2}' |xargs  kill -9``
- *缓存方案*
    - replication sentinal 哨兵
    - redis cluster 集群

- *如何持久化*
    - rdb : `` save 900 1 `` , ``save 300 10`` , ``save 60 10000 ``
    - aof : ``appendonly yes`` , `` appendfsync everysec ``

- *一致性问题解决方案*
    - 异步串行化

















- end 