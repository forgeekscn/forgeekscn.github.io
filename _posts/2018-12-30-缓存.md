---
layout:  post
title:		缓存
subtitle:		缓存
date:     2018-12-30
author:   Fogeeks
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - Redis
    - 缓存
---

#### *适用场景*
    - 热点数据缓存以提高响应速度，如hset，用户信息，工单状态信息，产品类型信息，来源信息，地址信息
    - 消息队列,如lpush rpop ,sub/pub
    - 排行榜 如zadd zrange zrank
    - 计数器 如incr
    - 共同关注 如 sadd spop sunion
    - 分布式锁 如 set lock true ex 1 xx

#### *缓存方案*
    - replication sentinal 哨兵 ， 支持故障转移，水平扩容时的数据迁移是瓶颈，所以只适合轻量级缓存
    - redis cluster 集群， 支持故障转移和水平扩容，数据分发到16384个hashslot，适合大型缓存系统

#### *持久化*
    - rdb : `` save 600 10 `` 10分钟内有10个键被改动就会触发rdb备份 ，保存键值数据，备份时间较长，有数据丢失的风险， 恢复速度快，备份文件较小
    - aof : `` appendfsync everysec `` 每秒备份一次 ，写命令追加到缓冲区末，随后写入aof文件并同步，数据更安全，恢复速度较慢，备份文件较大

#### *一致性问题解决方*
    - 异步串行化

#### *主从复制*
    - 周期性发送同步命令，异步复制并发送rdb数据
    - 清除旧数据刷新新数据到内存，这段时间服务不可用

#### *搭建细节*
    - redis安装目录 ： ``mkdir -p /usr/local/redis-cluster/redis-5.0.3``
    - redis启动脚本：
        ```$xslt
           cd ../node-1 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-2 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-3 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-4 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-5 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           cd ../node-6 &&  sudo ../redis-5.0.3/src/redis-server redis.conf
           ps -ef | grep redis-server
           sudo redis-5.0.3/src/redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006  --cluster-replicas 1
        ```        
    - 连接redis： ``redis-5.0.3/src/redis-cli -c -p 7001``
    - 增删redis集群节点
        ```$xslt
            redis-5.0.3/src/redis-cli --cluster add-node 127.0.0.1:7002  127.0.0.1:7001
            redis-5.0.3/src/redis-cli --cluster del-node 127.0.0.1:7002 bd64b831c5fb0a19fe357fc7eef00cfe41c2734d
        ```
    - 干翻所有redis: ``ps -ef |grep redis-server  | awk '/cluster/{print$2}' |xargs  kill -9``
#### *缓存方案*
    - replication sentinal 哨兵
    - redis cluster 集群

#### *如何持久化*
    - rdb : `` save 900 1 `` , ``save 300 10`` , ``save 60 10000 ``
    - aof : ``appendonly yes`` , `` appendfsync everysec ``

#### *一致性问题解决方案*
    - 异步串行化

#### 引用
    ```
        1.各个中间件数据分片原理：
            redis： 16K个hashslot分配到各个master节点 ，master写slave读，每秒同步一次，不同key存储到不同hashslot，master节点宕机那么他的slave会成为mater
        2.计算redis nodes hashslot数量
            redis-5.0.3/src/redis-cli -c -p 7001 cluster nodes | grep master | awk '//{print$2 ,$9}'
    ```

    ```
        3.增删redis集群节点
            redis-5.0.3/src/redis-cli --cluster add-node 127.0.0.1:7002  127.0.0.1:7001
            redis-5.0.3/src/redis-cli --cluster del-node 127.0.0.1:7002 bd64b831c5fb0a19fe357fc7eef00cfe41c2734d
    ```
    ```
        4.各个中间件数据分片原理：
            redis： 16K个hashslot分配到各个master节点 ，master写slave读，每秒同步一次，不同key存储到不同hashslot，master节点宕机那么他的slave会成为mater
    ```
    ```
        - [在项目中缓存是如何使用的？缓存如果使用不当会造成什么后果？](/docs/high-concurrency/why-cache.md)
        - [Redis 和 Memcached 有什么区别？Redis 的线程模型是什么？为什么单线程的 Redis 比多线程的 Memcached 效率要高得多？](/docs/high-concurrency/redis-single-thread-model.md)
        - [Redis 都有哪些数据类型？分别在哪些场景下使用比较合适？](/docs/high-concurrency/redis-data-types.md)
        - [Redis 的过期策略都有哪些？手写一下 LRU 代码实现？](/docs/high-concurrency/redis-expiration-policies-and-lru.md)
        - [如何保证 Redis 高并发、高可用？Redis 的主从复制原理能介绍一下么？Redis 的哨兵原理能介绍一下么？](/docs/high-concurrency/how-to-ensure-high-concurrency-and-high-availability-of-redis.md)
        - [Redis 的持久化有哪几种方式？不同的持久化机制都有什么优缺点？持久化机制具体底层是如何实现的？](/docs/high-concurrency/redis-persistence.md)
        - [Redis 集群模式的工作原理能说一下么？在集群模式下，Redis 的 key 是如何寻址的？分布式寻址都有哪些算法？了解一致性 hash 算法吗？如何动态增加和删除一个节点？](/docs/high-concurrency/redis-cluster.md)
        - [了解什么是 Redis 的雪崩和穿透？Redis 崩溃之后会怎么样？系统该如何应对这种情况？如何处理 Redis 的穿透？](/docs/high-concurrency/redis-caching-avalanche-and-caching-penetration.md)
        - [如何保证缓存与数据库的双写一致性？](/docs/high-concurrency/redis-consistence.md)
        - [Redis 的并发竞争问题是什么？如何解决这个问题？了解 Redis 事务的 CAS 方案吗？](/docs/high-concurrency/redis-cas.md)
        - [生产环境中的 Redis 是怎么部署的？](/docs/high-concurrency/redis-production-environment.md)
    ```


#### 存取详细步骤
  ![](https://github.com/forgeekscn/forgeekscn.github.io/blob/master/img/xmid/1.png?raw=true)

#### 容灾备份
  ![](https://github.com/forgeekscn/forgeekscn.github.io/blob/master/img/xmid/2.png?raw=true)

#### 主从复制

#### 数据一致性












- end
